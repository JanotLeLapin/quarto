<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>quarto example</title>
  <link rel="stylesheet" href="quarto.css" />
</head>

<body>
  <script defer type="module">
    import * as quarto from "./quarto.js";

    let boardSlots = quarto.initBoard()
    let stagedSlot = quarto.initStaged()

    let pieceToPlay = undefined

    function updateBoardSlot(x, y, piece) {
      const i = x * 4 + y
      const slot = boardSlots[i]
      quarto.updateSlot(slot, piece)
    }

    function updateStagedSlot(piece) {
      quarto.updateSlot(stagedSlot, piece)
    }

    async function updateStatus() {
      const q = await quarto.getQuarto()
      const winner = q.get_winner()
      if (winner) {
        document.getElementById("status").textContent
          = "Winner: " + quarto.getPlayerNames()[winner]
        return
      }

      document.getElementById("status").textContent
        = "Player "
        + quarto.getPlayerNames()[q.get_current_player()]
        + " is "
        + (pieceToPlay ? "playing" : "picking")
    }

    async function pick() {
      const q = await quarto.getQuarto()
      pieceToPlay = q.give_piece()
      q.pick_piece(pieceToPlay)
      console.log("picked")
      updateStagedSlot(pieceToPlay)
    }

    async function play() {
      const q = await quarto.getQuarto()
      let [x, y] = q.play_piece(pieceToPlay)
      q.place_piece(x, y, pieceToPlay)
      updateBoardSlot(x, y, pieceToPlay)
      updateStagedSlot(0xFF)
    }

    document.getElementById("next").addEventListener("click", async (_) => {
      const q = await quarto.getQuarto()
      if (undefined != q.get_winner()) {
        return
      }

      if (undefined != pieceToPlay) {
        await play()
        pieceToPlay = undefined
      } else {
        await pick()
      }

      updateStatus()
    })
  </script>

  <h1 id="status">Quarto</h1>

  <div id="board"></div>
  <div id="staged"></div>

  <button id="next">Next</button>
</body>

</html>