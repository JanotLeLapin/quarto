<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>quarto example</title>
  <link rel="stylesheet" href="quarto.css" />
</head>

<body>
  <script defer type="module">
    import * as quarto from "./quarto.js";

    const HUMAN_IDX = 0

    let userPromisePlayResolve
    let userPromisePlay = new Promise((resolve, _) => {
      userPromisePlayResolve = resolve
    })

    let userPromisePickResolve
    let userPromisePick = new Promise((resolve, _) => {
      userPromisePickResolve = resolve
    })

    let pieceToPlay = undefined

    let boardSlots = quarto.initBoard(async (piece) => {
      const q = await quarto.getQuarto()
      if (HUMAN_IDX != q.get_current_player()) {
        return
      }

      if (pieceToPlay == undefined) {
        return
      }

      userPromisePlayResolve(piece)
    })
    let stagedSlot = quarto.initStaged()
    let stackSlots = quarto.initStack(async (piece) => {
      const q = await quarto.getQuarto()
      if (HUMAN_IDX != q.get_current_player()) {
        return
      }

      if (pieceToPlay != undefined) {
        return
      }

      userPromisePickResolve(piece)
    })

    function updateBoardSlot(x, y, piece) {
      const i = x * 4 + y
      const slot = boardSlots[i]
      quarto.updateSlot(slot, piece)
    }

    function updateStackSlot(piece) {
      const slot = stackSlots[piece]
      quarto.updateSlot(slot, 0xFF)
    }

    function updateStagedSlot(piece) {
      quarto.updateSlot(stagedSlot, piece)
    }

    async function updateStatus() {
      const q = await quarto.getQuarto()
      const winner = q.get_winner()
      if (winner) {
        document.getElementById("status").textContent
          = "Winner: " + quarto.getPlayerNames()[winner]
        return
      }

      document.getElementById("status").textContent
        = "Player "
        + quarto.getPlayerNames()[q.get_current_player()]
        + " is "
        + (pieceToPlay ? "playing" : "picking")
    }

    async function pick() {
      const q = await quarto.getQuarto()
      if (HUMAN_IDX == q.get_current_player()) {
        pieceToPlay = await userPromisePick

        userPromisePick = new Promise((resolve, _) => {
          userPromisePickResolve = resolve
        })
      } else {
        pieceToPlay = q.give_piece()
      }
      console.log(pieceToPlay)
      q.pick_piece(pieceToPlay)
      console.log("picked")

      updateStagedSlot(pieceToPlay)
      updateStackSlot(pieceToPlay)
    }

    async function play() {
      const q = await quarto.getQuarto()
      let x
      let y
      if (HUMAN_IDX == q.get_current_player()) {
        const piece = await userPromisePlay
        x = Math.floor(piece / 4)
        y = piece % 4

        userPromisePlay = new Promise((resolve, _) => {
          userPromisePlayResolve = resolve
        })
      } else {
        const [rx, ry] = q.play_piece(pieceToPlay)
        x = rx
        y = ry
      }
      q.place_piece(x, y, pieceToPlay)
      updateBoardSlot(x, y, pieceToPlay)
      updateStagedSlot(0xFF)
    }

    document.getElementById("next").addEventListener("click", async (_) => {
      const q = await quarto.getQuarto()
      if (undefined != q.get_winner()) {
        return
      }

      if (undefined != pieceToPlay) {
        await play()
        pieceToPlay = undefined
      } else {
        await pick()
      }

      updateStatus()
    })
  </script>

  <h1 id="status">Quarto</h1>

  <div id="board"></div>
  <div id="staged"></div>
  <div id="stack"></div>

  <button id="next">Next</button>
</body>

</html>