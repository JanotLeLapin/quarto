<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>quarto example</title>
  <link rel="stylesheet" href="quarto.css" />
</head>

<body>
  <script defer type="module">
    import init, {QuartoEngine} from "./pkg/quarto_wasm.js";

    let quarto

    let boardSlots = []
    let stagedSlot = document.getElementById("staged")

    let pieceToPlay = undefined

    function initBoard() {
      const board = document.getElementById("board")
      for (let i = 0; i < 16; i++) {
        const slot = document.createElement("div")
        slot.classList.add("piece")
        boardSlots.push(slot)
        board.appendChild(slot)
      }
    }

    function initStaged() {
      stagedSlot.classList.add("piece")
    }

    function updateSlot(slot, piece) {
      if (0xFF == piece) {
        slot.classList = "piece"
        return
      }

      if ((piece & 0x01) == 0x01) {
        slot.classList.add("is-light")
      } else {
        slot.classList.add("is-dark")
      }

      if ((piece & 0x02) == 0x02) {
        slot.classList.add("is-square")
      } else {
        slot.classList.add("is-circle")
      }

      if ((piece & 0x04) == 0x04) {
        slot.classList.add("is-tall")
      } else {
        slot.classList.add("is-short")
      }

      if ((piece & 0x08) == 0x08) {
        slot.classList.add("is-hollow")
      }
    }

    function updateBoardSlot(x, y, piece) {
      const i = x * 4 + y
      const slot = boardSlots[i]
      updateSlot(slot, piece)
    }

    function updateStagedSlot(piece) {
      updateSlot(stagedSlot, piece)
    }

    function updateStatus() {
      const winner = quarto.get_winner()
      if (winner) {
        document.getElementById("status").textContent
          = "Winner: " + winner
        return
      }

      document.getElementById("status").textContent
        = "Player "
        + quarto.get_current_player()
        + " is "
        + (pieceToPlay ? "playing" : "picking")
    }

    function pick() {
      pieceToPlay = quarto.give_piece()
      quarto.pick_piece(pieceToPlay)
      console.log("picked")
      updateStagedSlot(pieceToPlay)
    }

    function play() {
      let [x, y] = quarto.play_piece(pieceToPlay)
      quarto.place_piece(x, y, pieceToPlay)
      updateBoardSlot(x, y, pieceToPlay)
      updateStagedSlot(0xFF)
    }

    init().then(() => {
      quarto = new QuartoEngine()
      initBoard()
      initStaged()
    });

    document.getElementById("next").addEventListener("click", (_) => {
      if (undefined != quarto.get_winner()) {
        console.log("winner: " + quarto.get_winner())
        return
      }

      if (pieceToPlay) {
        play()
        pieceToPlay = undefined
      } else {
        pick()
      }

      updateStatus()
    })
  </script>

  <h1 id="status">Player 0 is picking</h1>

  <div id="board"></div>
  <div id="staged"></div>

  <button id="next">Next</button>
</body>

</html>